name: Build Windows

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      flavor:
        description: 'Flavor to build (mobile ou stoneP2)'
        required: false
        default: 'mobile'
        type: choice
        options:
          - mobile
          - stoneP2

jobs:
  build-windows:
    name: Build Windows App
    runs-on: windows-latest
    env:
      FLAVOR: ${{ github.event.inputs.flavor || 'mobile' }}
      BUILD_MODE: ${{ github.ref == 'refs/heads/main' && 'release' || 'debug' }}
      BUILD_TYPE: ${{ github.ref == 'refs/heads/main' && 'Release' || 'Debug' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Create Windows platform files (if needed)
        run: flutter create --platforms=windows .

      - name: Install dependencies
        run: flutter pub get

      - name: Verify Flutter setup
        run: flutter doctor -v

      - name: Build Windows
        run: |
          $flavor = "$env:FLAVOR"
          $buildMode = "$env:BUILD_MODE"
          $buildType = "$env:BUILD_TYPE"
          
          if ([string]::IsNullOrWhiteSpace($flavor) -or $flavor -eq '') {
            $flavor = "mobile"
          }
          
          Write-Host "=========================================="
          Write-Host "BUILD CONFIGURATION"
          Write-Host "Branch: ${{ github.ref }}"
          Write-Host "Flavor: $flavor"
          Write-Host "Build Mode: $buildMode"
          Write-Host "Build Type: $buildType"
          Write-Host "=========================================="
          
          if ($buildMode -eq "release") {
            Write-Host "Building in RELEASE mode (main branch)"
          flutter build windows --release --dart-define=FLAVOR=$flavor
          } else {
            Write-Host "Building in DEBUG mode (develop branch)"
            flutter build windows --debug --dart-define=FLAVOR=$flavor
          }
        continue-on-error: false

      - name: Remove stone_payments plugin (Windows fix)
        run: |
          Write-Host "=========================================="
          Write-Host "REMOVING STONE_PAYMENTS PLUGIN"
          Write-Host "=========================================="
          
          # Verifica se o build foi feito
          if (-not (Test-Path "build\windows")) {
            Write-Host "‚ùå Diret√≥rio build\windows n√£o existe"
            Write-Host "   O build do Flutter pode n√£o ter sido executado"
            Write-Host "   Continuando sem modificar..."
            exit 0
          }
          
          # Busca o arquivo em todos os locais poss√≠veis
          Write-Host "üîç Procurando arquivo generated_plugin_registrant.cc..."
          
          $pluginFile = $null
          
          # Busca recursiva primeiro (mais confi√°vel)
          if (Test-Path "build\windows") {
            $foundFiles = Get-ChildItem "build\windows" -Recurse -Filter "generated_plugin_registrant.cc" -ErrorAction SilentlyContinue
            if ($foundFiles -and $foundFiles.Count -gt 0) {
              $pluginFile = $foundFiles[0].FullName
              Write-Host "‚úÖ Arquivo encontrado via busca recursiva: $pluginFile"
            }
          }
          
          # Se n√£o encontrou, tenta os caminhos esperados
          if (-not $pluginFile) {
            $searchPaths = @(
              "build\windows\flutter\generated_plugin_registrant.cc",
              "build\windows\x64\flutter\generated_plugin_registrant.cc",
              "windows\flutter\generated_plugin_registrant.cc"
            )
            
            foreach ($path in $searchPaths) {
              if (Test-Path $path) {
                $pluginFile = (Resolve-Path $path).Path
                Write-Host "‚úÖ Arquivo encontrado em: $pluginFile"
                break
              }
            }
          }
          
          $buildType = "$env:BUILD_TYPE"
          
          if (-not $pluginFile) {
            Write-Host "‚ö†Ô∏è Arquivo generated_plugin_registrant.cc n√£o encontrado"
            Write-Host "   Verificando estrutura de diret√≥rios..."
            if (Test-Path "build\windows") {
              Write-Host "   Diret√≥rio build\windows existe"
              Write-Host "   Conte√∫do de build\windows:"
              Get-ChildItem "build\windows" -Directory | ForEach-Object { Write-Host "     - $($_.Name)" }
              Write-Host "   Buscando arquivos *plugin*:"
              $pluginFiles = Get-ChildItem "build\windows" -Recurse -Filter "*plugin*" -ErrorAction SilentlyContinue
              if ($pluginFiles) {
                $pluginFiles | ForEach-Object { Write-Host "     - $($_.FullName)" }
              } else {
                Write-Host "     Nenhum arquivo *plugin* encontrado"
              }
            }
            Write-Host "   ‚ö†Ô∏è Continuando sem modificar (plugin pode n√£o estar sendo registrado ou build incompleto)"
            Write-Host "   Isso pode significar que:"
            Write-Host "     1. O plugin stone_payments n√£o est√° sendo inclu√≠do no build"
            Write-Host "     2. O build ainda n√£o foi conclu√≠do"
            Write-Host "     3. O arquivo est√° em um local diferente"
            Write-Host "   Se o erro de DLL persistir, verifique manualmente o arquivo gerado"
          } else {
            Write-Host "üîß Removendo plugin stone_payments do registro..."
            
            # Cria backup
            $backupFile = "$pluginFile.bak"
            Copy-Item $pluginFile $backupFile
            Write-Host "   Backup criado: $backupFile"
            
            # L√™ o conte√∫do do arquivo
            $content = Get-Content $pluginFile -Raw
            
            # Remove includes do stone_payments
            $content = $content -replace '#include <stone_payments/stone_payments_plugin\.h>', '// #include <stone_payments/stone_payments_plugin.h> // Removido: n√£o suporta Windows'
            
            # Remove registro do plugin (linha completa - pode estar em m√∫ltiplas linhas)
            $content = $content -replace 'stone_payments::StonePaymentsPluginRegisterWithRegistrar\([^)]*\);', '// stone_payments plugin removido (n√£o suporta Windows)'
            
            # Remove linhas vazias duplicadas
            $content = $content -replace "(\r?\n\s*){3,}", "`r`n`r`n"
            
            # Salva o arquivo modificado
            Set-Content -Path $pluginFile -Value $content -NoNewline
            
            Write-Host "‚úÖ Plugin stone_payments removido do registro"
            Write-Host "   Arquivo modificado: $pluginFile"
            
            # Recompila apenas o execut√°vel usando CMake (sem fazer flutter build novamente)
            Write-Host "üî® Recompilando execut√°vel com plugin removido..."
            $cmakeBuildDir = "build\windows"
            if (Test-Path "$cmakeBuildDir\CMakeCache.txt") {
              cd $cmakeBuildDir
              cmake --build . --config $buildType
              cd ..\..
              Write-Host "‚úÖ Execut√°vel recompilado sem o plugin stone_payments"
            } else {
              Write-Host "‚ö†Ô∏è CMakeCache.txt n√£o encontrado, fazendo build completo novamente..."
              # Se n√£o conseguir recompilar com CMake, faz build completo novamente
              # Mas primeiro protege o arquivo modificado
              $protectedFile = "$pluginFile.protected"
              Copy-Item $pluginFile $protectedFile
              
              $flavor = "$env:FLAVOR"
              $buildMode = "$env:BUILD_MODE"
              if ([string]::IsNullOrWhiteSpace($flavor) -or $flavor -eq '') {
                $flavor = "mobile"
              }
              
              if ($buildMode -eq "release") {
                flutter build windows --release --dart-define=FLAVOR=$flavor
              } else {
                flutter build windows --debug --dart-define=FLAVOR=$flavor
              }
              
              # Restaura o arquivo modificado
              Copy-Item $protectedFile $pluginFile -Force
              Remove-Item $protectedFile
              
              # Recompila novamente
              cd $cmakeBuildDir
              cmake --build . --config $buildType
              cd ..\..
              
              Write-Host "‚úÖ Execut√°vel recompilado sem o plugin stone_payments"
            }
          }
        continue-on-error: true  # N√£o falha o build se o arquivo n√£o for encontrado

      - name: Create ZIP artifact
        run: |
          $versionLine = Get-Content pubspec.yaml | Select-String 'version:'
          $version = ($versionLine.Line -split ':')[1].Trim()
          $flavor = "$env:FLAVOR"
          $buildMode = "$env:BUILD_MODE"
          $buildType = "$env:BUILD_TYPE"
          
          if ([string]::IsNullOrWhiteSpace($flavor) -or $flavor -eq '') {
            $flavor = "mobile"
          }
          
          $zipName = "mx_cloud_pdv_windows_${flavor}_${buildMode}_${version}.zip"
          
          Write-Host "=========================================="
          Write-Host "CREATING ZIP ARTIFACT"
          Write-Host "Build Type: $buildType"
          Write-Host "Source Path: build\windows\x64\runner\$buildType\*"
          Write-Host "ZIP Name: $zipName"
          Write-Host "=========================================="
          
          # Verificar se o diret√≥rio existe
          $sourcePath = "build\windows\x64\runner\$buildType"
          if (-not (Test-Path $sourcePath)) {
            Write-Host "ERROR: Build directory does not exist: $sourcePath"
            Write-Host "Available directories:"
            Get-ChildItem "build\windows\x64\runner\" -Directory | ForEach-Object { Write-Host "  - $($_.Name)" }
            exit 1
          }
          
          Write-Host "Creating ZIP from: $sourcePath"
          Compress-Archive -Path "$sourcePath\*" -DestinationPath $zipName -Force
          
          Write-Host "ZIP_NAME=$zipName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          if (Test-Path $zipName) {
            Write-Host "ZIP created successfully: $zipName"
            Get-Item $zipName | Select-Object Name, Length
          } else {
            Write-Host "ERROR: ZIP file was not created!"
            exit 1
          }

      - name: Upload Windows build artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-${{ env.FLAVOR }}-${{ env.BUILD_MODE }}
          path: |
            build/windows/x64/runner/${{ env.BUILD_TYPE }}/**
            *.zip
          retention-days: 30
          if-no-files-found: error

      - name: Create Release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

